# 🛡️ Defender - PDF 水印嵌入与验证工具

Defender 是 PhantomStream 攻防演习系统的防守方工具，用于在 PDF 文件中嵌入加密的追踪信息，并能够随时提取验证。

## 📋 目录

- [特性](#特性)
- [技术原理](#技术原理)
- [安装](#安装)
- [快速开始](#快速开始)
- [使用指南](#使用指南)
- [架构设计](#架构设计)
- [安全性](#安全性)
- [FAQ](#faq)

## ✨ 特性

- **🔐 强加密保护**：使用 AES-256-GCM 加密算法，确保追踪信息安全
- **📎 隐蔽嵌入**：利用 PDF 标准附件特性，完全不影响文件阅读体验
- **🛡️ 抗清洗攻击**：成功抵御多种攻击手段（截断、回滚、图谱清洗等）
- **✅ 易于验证**：随时提取并验证追踪信息的完整性
- **🎯 稳定可靠**：基于标准 PDF 库实现，工程稳定性高
- **📦 零依赖部署**：编译为单个二进制文件，无需额外依赖

## 🔬 技术原理

### Phase 6: 嵌入式附件策略

Defender 采用 **Phase 6** 方案，将加密后的追踪信息封装为 PDF 标准附件（Embedded File），挂载在文档的引用树上：

```
PDF 文件结构：
┌─────────────────────────┐
│  Catalog (根节点)        │
│    ├── Pages Tree       │  ← 正文内容
│    └── Names Dict       │
│         └── EmbeddedFiles│  ← 附件树
│              └── sys_stream.dat  ← 追踪信息驻留于此
└─────────────────────────┘
```

**核心优势：**
1. **合法性**：附件是 PDF ISO 32000 标准特性
2. **可达性**：被 Root 引用，属于合法结构组件
3. **抗回滚**：pdfcpu 自动优化，消除增量更新历史
4. **抗清洗**：图谱分析工具将其识别为合法对象并保留

## 🚀 安装

### 从源码编译

```bash
# 克隆项目
cd defender

# 编译
go build -o defender

# 验证安装
./defender --version
```

### 系统要求

- Go 1.24.0 或更高版本
- 支持 macOS、Linux、Windows

## 🎯 快速开始

### 1. 签名 PDF 文件

为 PDF 文件嵌入追踪信息：

```bash
./defender sign \
  -f /path/to/document.pdf \
  -m "UserID:12345" \
  -k "12345678901234567890123456789012"
```

**参数说明：**
- `-f, --file`: 源 PDF 文件路径
- `-m, --msg`: 要嵌入的追踪信息（如员工 ID、追踪码等）
- `-k, --key`: 32 字节加密密钥

**输出：**
- 生成签名文件：`document_signed.pdf`
- 原文件保持不变

### 2. 验证追踪信息

从签名的 PDF 文件中提取并验证追踪信息：

```bash
./defender verify \
  -f /path/to/document_signed.pdf \
  -k "12345678901234567890123456789012"
```

**输出示例：**
```
🔍 Defender Verify Operation
   File: document_signed.pdf

✅ Verification successful!
📋 Extracted message: "UserID:12345"
```

## 📖 使用指南

### 签名命令详解

```bash
defender sign [flags]

Flags:
  -f, --file string   源 PDF 文件路径 (必填)
  -m, --msg string    要嵌入的追踪信息 (必填)
  -k, --key string    32 字节加密密钥 (必填)
  -h, --help          显示帮助信息
```

**使用示例：**

```bash
# 基础用法
./defender sign -f report.pdf -m "Employee:Alice" -k "your-32-byte-secret-key-here!!"

# 嵌入复杂信息
./defender sign -f contract.pdf -m "TrackID:ABC-2024-001|Dept:Sales" -k "your-32-byte-secret-key-here!!"
```

### 验证命令详解

```bash
defender verify [flags]

Flags:
  -f, --file string   目标 PDF 文件路径 (必填)
  -k, --key string    32 字节解密密钥 (必填)
  -h, --help          显示帮助信息
```

**可能的错误：**

| 错误信息 | 原因 | 解决方案 |
|---------|------|---------|
| `file does not exist` | 文件不存在 | 检查文件路径 |
| `encryption key must be 32 bytes long` | 密钥长度错误 | 确保密钥正好 32 字节 |
| `attachment not found` | 文件未被签名 | 使用正确的签名文件 |
| `decryption failed` | 密钥错误或数据损坏 | 使用正确的密钥 |

### 密钥生成建议

**方法 1：使用随机字符串**
```bash
# 生成 32 字节随机密钥（Base64）
openssl rand -base64 32 | head -c 32
```

**方法 2：使用密码短语**
```bash
# 从密码短语派生密钥
echo -n "your-passphrase" | openssl dgst -sha256 -binary | base64 | head -c 32
```

**重要提示：**
- ⚠️ 密钥必须安全保存，丢失后无法恢复追踪信息
- ⚠️ 不同文件应使用不同密钥以提高安全性
- ⚠️ 密钥不应在代码或配置文件中明文存储

## 🏗️ 架构设计

### 项目结构

```
defender/
├── main.go              # CLI 入口，命令行处理
├── injector/
│   └── watermark.go     # 核心逻辑：加密、嵌入、提取、解密
├── testdata/            # 测试文件
├── go.mod               # Go 模块依赖
└── README.md            # 本文档
```

### 核心模块

#### 1. 签名流程 (Sign)

```
输入 (PDF + 消息 + 密钥)
    ↓
[1] 输入验证 (文件存在性、密钥长度、PDF 格式)
    ↓
[2] 创建加密 Payload
    • 生成随机 Nonce (12 字节)
    • AES-256-GCM 加密消息
    • 组装: Magic Header + Nonce + 加密数据
    ↓
[3] 写入临时文件 (权限 0600)
    ↓
[4] 添加为 PDF 附件 (pdfcpu API)
    • 附件名: sys_stream.dat
    • 自动优化文件结构
    ↓
[5] 生成签名文件 (*_signed.pdf)
    ↓
输出 (签名的 PDF)
```

#### 2. 验证流程 (Verify)

```
输入 (签名 PDF + 密钥)
    ↓
[1] 输入验证 (文件存在性、密钥长度)
    ↓
[2] 提取附件 (pdfcpu API)
    • 查找 sys_stream.dat 附件
    • 解析到临时目录
    ↓
[3] 读取并验证 Payload
    • 检查 Magic Header (0xCA 0xFE 0xBA 0xBE)
    • 提取 Nonce 和加密数据
    ↓
[4] 解密
    • AES-256-GCM 解密
    • 验证完整性
    ↓
[5] 返回原始消息
    ↓
输出 (追踪信息)
```

### 数据格式

**Payload 结构：**
```
+------------------+------------------+------------------+
| Magic Header     | Nonce            | Encrypted Data   |
| (4 bytes)        | (12 bytes)       | (Variable)       |
+------------------+------------------+------------------+
| 0xCA 0xFE 0xBA   | Random           | AES-GCM          |
| 0xBE             | 12 bytes         | Encrypted Msg    |
+------------------+------------------+------------------+
```

## 🔒 安全性

### 加密算法

- **算法**：AES-256-GCM (Galois/Counter Mode)
- **密钥长度**：256 位 (32 字节)
- **认证**：内置完整性验证，防止数据篡改
- **随机性**：每次签名生成新的随机 Nonce

### 安全特性

✅ **机密性**：即使攻击者获取文件，没有密钥也无法读取追踪信息  
✅ **完整性**：GCM 模式自动验证数据完整性，防止篡改  
✅ **隐蔽性**：追踪信息伪装为系统文件，不易被发现  
✅ **抗攻击**：成功抵御截断、回滚、图谱清洗等多种攻击

### 安全最佳实践

1. **密钥管理**
   - 使用强随机密钥（至少 256 位熵）
   - 安全存储密钥（使用密钥管理系统或环境变量）
   - 定期轮换密钥

2. **文件保护**
   - 原始文件和签名文件分开存储
   - 限制签名文件的访问权限
   - 记录所有签名和验证操作

3. **操作安全**
   - 不在命令历史中暴露密钥（使用环境变量）
   - 验证后立即清除临时文件
   - 监控异常的验证失败

## 🎮 攻防演习历史

Defender 在 PhantomStream 攻防演习中经历了六个阶段的进化：

| 阶段 | 策略 | 红队攻击 | 结果 |
|------|------|---------|------|
| Phase 1-2 | EOF 追加 / 间隙注入 | 截断 / 间隙覆盖 | ❌ 失败 |
| Phase 3 | 增量更新伪装 | 版本回滚 | ❌ 失败 |
| Phase 4 | 僵尸对象注入 | 图谱修剪 | ❌ 失败 |
| **Phase 6** | **嵌入式附件** | **图谱清洗** | **✅ 成功** |

**Phase 6 成功的关键：**
- 🎯 将追踪信息"合法化"为 PDF 标准组件
- 🌳 挂载在引用树上，确保可达性
- 🔄 利用 pdfcpu 优化特性，抗回滚攻击
- 🛡️ 红队无法在不破坏文件功能的前提下清除

详细演习报告：[/docs/TOTAL_REPORTv1.0.md](../docs/TOTAL_REPORTv1.0.md)

## ❓ FAQ

### Q1: 签名后的 PDF 文件会变大吗？

A: 不会显著变大。由于 pdfcpu 在添加附件时会优化文件结构，实际上文件可能反而略微减小。追踪信息本身通常只有几十字节。

### Q2: 签名后的 PDF 是否还能正常阅读？

A: 完全可以。所有主流 PDF 阅读器（Adobe Acrobat、Chrome、Preview 等）都能正常打开和阅读签名后的文件。

### Q3: 用户能看到附件吗？

A: 技术上可以。如果用户在 PDF 阅读器中打开"附件"面板，会看到一个名为 `sys_stream.dat` 的文件。但普通用户通常不会查看附件列表，且文件名具有一定的迷惑性。

**建议改进：** 可以将附件名改为更具迷惑性的名称，如 `font_license.txt` 或 `.pdf_metadata`。

### Q4: 如果忘记密钥怎么办？

A: 无法恢复。AES-256-GCM 是强加密算法，没有密钥就无法解密。因此密钥管理至关重要。

**建议：** 使用密钥管理系统（如 HashiCorp Vault）或安全地记录密钥。

### Q5: 能否对已签名的文件再次签名？

A: 可以，但会生成新的附件。由于附件名相同，可能会覆盖原有追踪信息。

**建议：** 使用不同的附件名或在消息中包含版本信息。

### Q6: 红队能否清除追踪信息？

A: 理论上可以，但代价高昂：
- **删除所有附件**：会误删合法的参考文件
- **人工审核**：无法自动化，成本极高
- **语义分析**：需要 AI 判断附件用途，目前技术难度大

在 Phase 6 的实战演习中，红队的自动化清洗工具**无法清除**追踪信息。

### Q7: 密钥长度为什么必须是 32 字节？

A: AES-256 算法要求密钥长度为 256 位（32 字节）。这是算法规范的要求，确保加密强度。

### Q8: 能否批量处理多个文件？

A: 当前版本不支持。但可以通过 shell 脚本实现：

```bash
#!/bin/bash
KEY="your-32-byte-secret-key-here!!"

for file in *.pdf; do
  ./defender sign -f "$file" -m "Batch:$(date +%s)" -k "$KEY"
done
```

## 🔮 未来改进方向

- [ ] **批量处理**：支持一次签名多个文件
- [ ] **配置文件**：支持 `.defenderrc` 配置默认参数
- [ ] **附件名伪装**：支持自定义附件名以增强隐蔽性
- [ ] **多重锚点**：结合零宽字符等其他隐写技术
- [ ] **密钥派生**：支持从密码短语自动派生密钥
- [ ] **日志系统**：记录所有签名和验证操作
- [ ] **Web API**：提供 REST API 接口

## 📜 许可证

本项目是 PhantomStream 攻防演习系统的一部分，仅用于教育和研究目的。

## 🤝 贡献

如有问题或建议，请提交 Issue 或 Pull Request。

---

**Defender - 守护您的数字资产！** 🛡️✨
