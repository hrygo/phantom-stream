# ğŸ›¡ï¸ Defender - PDF æ°´å°åµŒå…¥ä¸éªŒè¯å·¥å…·

**æ‰§è¡Œæ‘˜è¦**: Defender æ˜¯ PhantomStream æ”»é˜²æ¼”ä¹ ç³»ç»Ÿçš„é˜²å®ˆæ–¹å·¥å…·ï¼Œæ—¨åœ¨ PDF æ–‡ä»¶ä¸­åµŒå…¥åŠ å¯†çš„è¿½è¸ªä¿¡æ¯ï¼Œå¹¶æä¾›å¼ºå¤§çš„éªŒè¯æœºåˆ¶ã€‚ç»è¿‡å¤šè½®æ”»é˜²æ¼”ä¹ ï¼ŒDefender å·²ä»æœ€åˆçš„å•é”šç‚¹é˜²å¾¡ï¼ˆPhase 5ï¼‰å‡çº§è‡³ **Phase 8 å¤šé”šç‚¹é˜²å¾¡ï¼ˆAttachment + SMask + Content + Visualï¼‰**ï¼Œå¹¶é€šè¿‡æ¶æ„é‡æ„æ˜¾è‘—æå‡äº†ç³»ç»Ÿçš„å¯æ‰©å±•æ€§å’Œç»´æŠ¤æ€§ã€‚ç›®å‰ï¼ŒDefender èƒ½å¤Ÿæœ‰æ•ˆæŠµå¾¡çº¢é˜Ÿå·²çŸ¥çš„å„ç§æ”»å‡»æ‰‹æ®µï¼Œæä¾›é«˜éšè”½æ€§å’Œå¼ºéŸ§æ€§çš„è¿½è¸ªä¿¡æ¯ä¿æŠ¤ã€‚

## ğŸ“‹ ç›®å½•

- [æ‰§è¡Œæ‘˜è¦](#æ‰§è¡Œæ‘˜è¦)
- [ç‰¹æ€§](#ç‰¹æ€§)
- [æŠ€æœ¯åŸç†ï¼šå¤šé”šç‚¹é˜²å¾¡](#æŠ€æœ¯åŸç†å¤šé”šç‚¹é˜²å¾¡)
- [å®‰è£…](#å®‰è£…)
- [å¿«é€Ÿå¼€å§‹](#å¿«é€Ÿå¼€å§‹)
- [ä½¿ç”¨æŒ‡å—](#ä½¿ç”¨æŒ‡å—)
- [æ¶æ„è®¾è®¡](#æ¶æ„è®¾è®¡)
  - [è®¾è®¡åŸåˆ™](#è®¾è®¡åŸåˆ™)
  - [æ¨¡å—ç»“æ„](#æ¨¡å—ç»“æ„)
  - [æ ¸å¿ƒç»„ä»¶](#æ ¸å¿ƒç»„ä»¶)
- [å·¥ä½œæµç¨‹](#å·¥ä½œæµç¨‹)
- [æ‰©å±•æ€§ç¤ºä¾‹](#æ‰©å±•æ€§ç¤ºä¾‹)
- [æ€§èƒ½æŒ‡æ ‡](#æ€§èƒ½æŒ‡æ ‡)
- [å®‰å…¨æ€§ï¼šæ·±å…¥è§£æ](#å®‰å…¨æ€§æ·±å…¥è§£æ)
- [æ”»é˜²æ¼”ä¹ å†å²](#æ”»é˜²æ¼”ä¹ å†å²)
- [FAQ](#faq)
- [æœªæ¥æ”¹è¿›æ–¹å‘](#æœªæ¥æ”¹è¿›æ–¹å‘)
- [è®¸å¯è¯](#è®¸å¯è¯)
- [è´¡çŒ®](#è´¡çŒ®)

## âœ¨ ç‰¹æ€§

- **ğŸ” å¼ºåŠ å¯†ä¿æŠ¤**ï¼šä½¿ç”¨ AES-256-GCM åŠ å¯†ç®—æ³•ï¼Œç¡®ä¿è¿½è¸ªä¿¡æ¯å®‰å…¨
- **ğŸ”— å¤šé”šç‚¹é˜²å¾¡**ï¼šæ”¯æŒ Attachmentã€SMaskã€Contentã€Visual å››ç§é”šç‚¹ç­–ç•¥
- **ğŸ•µï¸â€â™‚ï¸ æé«˜éšè”½æ€§**ï¼šSMask å’Œ Content é”šç‚¹ä¸æ˜“è¢«å¯Ÿè§‰å’Œæ¸…é™¤
- **ğŸ›¡ï¸ æŠ—æ¸…æ´—æ”»å‡»**ï¼šæœ‰æ•ˆæŠµå¾¡çº¢é˜Ÿç²¾å‡†æµæ¸…æ´—ç­‰å¤šç§æ”»å‡»æ‰‹æ®µ
- **âœ… æ™ºèƒ½éªŒè¯**ï¼šæ”¯æŒ Autoï¼ˆå¿«é€Ÿï¼‰å’Œ Allï¼ˆå®Œæ•´è¯Šæ–­ï¼‰ä¸¤ç§éªŒè¯æ¨¡å¼
- **ğŸ”„ æ¶æ„çµæ´»**ï¼šæ¨¡å—åŒ–è®¾è®¡æ”¯æŒè½»æ¾æ‰©å±•æ–°é”šç‚¹ç±»å‹
- **ğŸ¯ æ˜“ç”¨æ€§å¢å¼º**ï¼šäº¤äº’æ¨¡å¼æä¾› Lookup åŠŸèƒ½ï¼Œä¸€é”®éªŒè¯ä¸Šæ¬¡ç­¾åæ–‡ä»¶
- **ğŸ“¦ é›¶ä¾èµ–éƒ¨ç½²**ï¼šç¼–è¯‘ä¸ºå•ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶ï¼Œæ— éœ€é¢å¤–ä¾èµ–

## ğŸ”¬ æŠ€æœ¯åŸç†ï¼šå¤šé”šç‚¹é˜²å¾¡

Defender é‡‡ç”¨ **å¤šé”šç‚¹é˜²å¾¡æ–¹æ¡ˆ**ï¼Œé€šè¿‡åŒæ—¶åµŒå…¥å¤šä¸ªç‹¬ç«‹çš„è¿½è¸ªé”šç‚¹æ¥æå‡é˜²å¾¡éŸ§æ€§ï¼š

1.  **ä¸»é”šç‚¹ï¼šé™„ä»¶ (Attachment)**  
    - å°†åŠ å¯†è¿½è¸ªä¿¡æ¯å°è£…ä¸º PDF æ ‡å‡†é™„ä»¶ï¼ˆ`font_license.txt`ï¼‰ï¼ŒæŒ‚è½½åœ¨æ–‡æ¡£å¼•ç”¨æ ‘ä¸Šã€‚
    - **ç‰¹ç‚¹**ï¼šåˆæ³•æ€§é«˜ï¼Œå…¼å®¹æ€§å¼ºï¼Œä½†æ˜“è¢«æ£€æµ‹ã€‚

2.  **éšè”½é”šç‚¹ï¼šå›¾åƒè½¯è’™ç‰ˆ (SMask)**  
    - å°†å¤‡ä»½è¿½è¸ªä¿¡æ¯åµŒå…¥åˆ° PDF å›¾åƒçš„é€æ˜åº¦è’™ç‰ˆï¼ˆSoft Maskï¼‰æ•°æ®ä¸­ã€‚
    - **ç‰¹ç‚¹**ï¼šæé«˜éšè”½æ€§ï¼Œå¯¹è§†è§‰æ— å½±å“ï¼Œéš¾ä»¥è¢«å¸¸è§„å·¥å…·æ£€æµ‹å’Œæ¸…é™¤ã€‚

3.  **å†…å®¹é”šç‚¹ï¼šContent Stream**  
    - å°†è¿½è¸ªä¿¡æ¯åµŒå…¥åˆ°é¡µé¢å†…å®¹æµä¸­ï¼Œä½¿ç”¨ä¸å¯è§çš„æ–‡æœ¬æ“ä½œç¬¦ã€‚
    - **ç‰¹ç‚¹**ï¼šä¸é¡µé¢æ¸²æŸ“é€»è¾‘ç»‘å®šï¼Œæ¸…æ´—å¯èƒ½å½±å“é¡µé¢æ˜¾ç¤ºã€‚

4.  **è§†è§‰é”šç‚¹ï¼šVisual Watermark**  
    - æ˜æ–‡æ°´å°ï¼Œç”¨äºéœ‡æ…‘ä½œç”¨ï¼Œä¸å‚ä¸è‡ªåŠ¨éªŒè¯ã€‚
    - **ç‰¹ç‚¹**ï¼šå¯è§å¨æ…‘ï¼Œæé†’ç”¨æˆ·æ–‡ä»¶å—ä¿æŠ¤ã€‚

**å¤šé”šç‚¹éªŒè¯æœºåˆ¶ï¼š**

-   ç­¾åæ—¶ï¼Œé»˜è®¤åµŒå…¥æ‰€æœ‰å¯ç”¨é”šç‚¹ï¼ˆMaximum æ¨¡å¼ï¼‰ã€‚  
-   éªŒè¯æ—¶ï¼Œæä¾›ä¸¤ç§æ¨¡å¼ï¼š
    - **Auto æ¨¡å¼**ï¼ˆé»˜è®¤ï¼‰ï¼šé‡åˆ°ç¬¬ä¸€ä¸ªæˆåŠŸçš„é”šç‚¹å³åœæ­¢ï¼Œå¿«é€ŸéªŒè¯ã€‚
    - **All æ¨¡å¼**ï¼šé€ä¸€å°è¯•æ‰€æœ‰é”šç‚¹ï¼Œæ˜¾ç¤ºæ¯ä¸€æ­¥ç»“æœï¼Œé€‚åˆè¯Šæ–­ã€‚

**æ ¸å¿ƒä¼˜åŠ¿ï¼š**
1.  **é«˜éŸ§æ€§**ï¼šçº¢é˜Ÿå¿…é¡»åŒæ—¶å‘ç°å¹¶æ¸…é™¤æ‰€æœ‰é”šç‚¹æ‰èƒ½ä½¿ç­¾åå®Œå…¨å¤±æ•ˆã€‚
2.  **é«˜éšè”½æ€§**ï¼šSMask å’Œ Content é”šç‚¹åˆ©ç”¨ PDF ç‰¹æ®Šç»“æ„ï¼Œæéš¾è¢«å‘ç°ã€‚
3.  **ç¬¦åˆæ ‡å‡†**ï¼šæ‰€æœ‰é”šç‚¹å‡åˆ©ç”¨ PDF ISO 32000 æ ‡å‡†ç‰¹æ€§ï¼Œä¸å½±å“æ–‡ä»¶é˜…è¯»ã€‚
4.  **çµæ´»éªŒè¯**ï¼šAuto æ¨¡å¼å¿«é€ŸéªŒè¯ï¼ŒAll æ¨¡å¼å®Œæ•´è¯Šæ–­ï¼Œæ»¡è¶³ä¸åŒåœºæ™¯éœ€æ±‚ã€‚
5.  **å¯è§å¨æ…‘**ï¼šVisual æ°´å°æä¾›æ˜æ–‡éœ‡æ…‘ï¼ŒåŒæ—¶å…¶ä»–é”šç‚¹æä¾›éšè”½ä¿æŠ¤ã€‚

## ğŸš€ å®‰è£…

### ä»æºç ç¼–è¯‘

```bash
# å…‹éš†é¡¹ç›®
cd defender

# ç¼–è¯‘
go build -o defender

# éªŒè¯å®‰è£…
./defender --version
```

### ç³»ç»Ÿè¦æ±‚

- Go 1.24.0 æˆ–æ›´é«˜ç‰ˆæœ¬
- æ”¯æŒ macOSã€Linuxã€Windows

## ğŸ¯ å¿«é€Ÿå¼€å§‹

### 1. ç­¾å PDF æ–‡ä»¶ï¼ˆå¤šé”šç‚¹ï¼‰

ä¸º PDF æ–‡ä»¶åµŒå…¥è¿½è¸ªä¿¡æ¯ï¼Œé»˜è®¤ä¼šå°è¯•åµŒå…¥æ‰€æœ‰å¯ç”¨é”šç‚¹ï¼ˆMaximum æ¨¡å¼ï¼‰ï¼š

```bash
./defender sign \
  -f /path/to/document.pdf \
  -m "UserID:12345" \
  -k "12345678901234567890123456789012"
```

**å‚æ•°è¯´æ˜ï¼š**
- `-f, --file`: æº PDF æ–‡ä»¶è·¯å¾„
- `-m, --msg`: è¦åµŒå…¥çš„è¿½è¸ªä¿¡æ¯ï¼ˆå¦‚å‘˜å·¥ IDã€è¿½è¸ªç ç­‰ï¼‰
- `-k, --key`: 32 å­—èŠ‚åŠ å¯†å¯†é’¥

**è¾“å‡ºç¤ºä¾‹ï¼š**
```
[*] Injecting Anchor 1/4: Attachment...
âœ“ Anchor Attachment embedded
[*] Injecting Anchor 2/4: SMask...
âœ“ Anchor SMask embedded
[*] Injecting Anchor 3/4: Content...
âœ“ Anchor Content embedded
[*] Injecting Anchor 4/4: Visual...
âœ“ Anchor Visual embedded
âœ“ Signature mode: 4-anchor strategy
âœ… Successfully signed PDF: document_signed.pdf
```
**æ³¨æ„**ï¼šå¦‚æœ PDF æ–‡ä»¶ä¸åŒ…å«å›¾åƒï¼ŒSMask é”šç‚¹å°†è‡ªåŠ¨è·³è¿‡ã€‚Visual æ°´å°ä»¥æ˜æ–‡å½¢å¼æ˜¾ç¤ºï¼Œç”¨äºéœ‡æ…‘ã€‚

### 2. éªŒè¯è¿½è¸ªä¿¡æ¯ï¼ˆå¤šé”šç‚¹å®¹é”™ï¼‰

ä»ç­¾åçš„ PDF æ–‡ä»¶ä¸­æå–å¹¶éªŒè¯è¿½è¸ªä¿¡æ¯ã€‚æ”¯æŒä¸¤ç§éªŒè¯æ¨¡å¼ï¼š

**Auto æ¨¡å¼ï¼ˆé»˜è®¤ï¼Œå¿«é€ŸéªŒè¯ï¼‰**ï¼š
```bash
./defender verify \
  -f /path/to/document_signed.pdf \
  -k "12345678901234567890123456789012"
```

**All æ¨¡å¼ï¼ˆå®Œæ•´è¯Šæ–­ï¼‰**ï¼š
```bash
./defender verify \
  -f /path/to/document_signed.pdf \
  -k "12345678901234567890123456789012" \
  --mode=all
```

**Auto æ¨¡å¼è¾“å‡ºç¤ºä¾‹ï¼š**
```
ğŸ” Defender Verify Operation
   File: document_signed.pdf

âœ“ Verified via Attachment
âœ… Verification successful!
ğŸ“‹ Extracted message: "UserID:12345"
```

**All æ¨¡å¼è¾“å‡ºç¤ºä¾‹ï¼š**
```
ğŸ” Defender Verify Operation
   File: document_signed.pdf

 - Trying Attachment... OK
   Message(Attachment): UserID:12345
 - Trying SMask... extract failed
 - Trying Content... OK
   Message(Content): UserID:12345
âœ… Verification finished (mode=all).
```

### 3. äº¤äº’æ¨¡å¼ (Interactive Mode)

å¦‚æœä¸å¸¦ä»»ä½•å‚æ•°è¿è¡Œ Defenderï¼Œå°†è¿›å…¥äº¤äº’æ¨¡å¼ï¼Œå¼•å¯¼æ‚¨å®Œæˆæ“ä½œï¼š

```bash
./defender
```

**äº¤äº’ç•Œé¢ç¤ºä¾‹ï¼š**
```
==================================================
   ğŸ›¡ï¸  Defender - PDF Protection Tool
==================================================
1. ğŸ”’ Protect PDF   (Embed invisible watermark)
2. ğŸ” Verify PDF    (Extract & verify watermark)
3. ğŸ” Lookup       (Verify last protected file, All mode)
4. ğŸšº Exit

Select option (1-4): 1

[Step 1/4] Enter PDF file path:
> docs/report.pdf

[Step 2/4] Enter watermark message:
> Secret Project X

[Step 3/4] Enter encryption key (32 chars) [Press Enter to generate]:
> 
[*] Generated Key: a1b2c3d4e5f6... (32 bytes)

[Step 4/4] Select protection level:
1. Standard  (Attachment only)
2. Stealth   (Attachment + SMask)
3. Maximum   (All anchors) - Default
4. Custom    (Select specific anchors)
> 

[*] Processing...
[*] Injecting Anchor 1/4: Attachment...
âœ“ Anchor Attachment embedded
[*] Injecting Anchor 2/4: SMask...
âœ“ Anchor SMask embedded
[*] Injecting Anchor 3/4: Content...
âœ“ Anchor Content embedded
[*] Injecting Anchor 4/4: Visual...
âœ“ Anchor Visual embedded

âœ… Success! File protected.
ğŸ”‘ Key: a1b2c3d4e5f6...
âš ï¸  SAVE THIS KEY! You need it to verify the file.
```

## ğŸ“– ä½¿ç”¨æŒ‡å—

### ç­¾åå‘½ä»¤è¯¦è§£

```bash
defender sign [flags]

Flags:
  -f, --file string   æº PDF æ–‡ä»¶è·¯å¾„ (å¿…å¡«)
  -m, --msg string    è¦åµŒå…¥çš„è¿½è¸ªä¿¡æ¯ (å¿…å¡«)
  -k, --key string    32 å­—èŠ‚åŠ å¯†å¯†é’¥ (å¿…å¡«)
  -h, --help          æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
```

**ä½¿ç”¨ç¤ºä¾‹ï¼š**

```bash
# åŸºç¡€ç”¨æ³•
./defender sign -f report.pdf -m "Employee:Alice" -k "your-32-byte-secret-key-here!!"

# åµŒå…¥å¤æ‚ä¿¡æ¯
./defender sign -f contract.pdf -m "TrackID:ABC-2024-001|Dept:Sales" -k "your-32-byte-secret-key-here!!"
```

### éªŒè¯å‘½ä»¤è¯¦è§£

```bash
defender verify [flags]

Flags:
  -f, --file string   ç›®æ ‡ PDF æ–‡ä»¶è·¯å¾„ (å¿…å¡«)
  -k, --key string    32 å­—èŠ‚è§£å¯†å¯†é’¥ (å¿…å¡«)
  --mode string       éªŒè¯æ¨¡å¼: auto|all (é»˜è®¤ auto)
  -h, --help          æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
```

**ä½¿ç”¨ç¤ºä¾‹ï¼š**

```bash
# Auto æ¨¡å¼ï¼ˆå¿«é€ŸéªŒè¯ï¼‰
./defender verify -f signed.pdf -k "your-32-byte-secret-key-here!!"

# All æ¨¡å¼ï¼ˆå®Œæ•´è¯Šæ–­ï¼‰
./defender verify -f signed.pdf -k "your-32-byte-secret-key-here!!" --mode=all
```

**å¯èƒ½çš„é”™è¯¯ï¼š**

| é”™è¯¯ä¿¡æ¯                               | åŸå›                | è§£å†³æ–¹æ¡ˆ             |
| -------------------------------------- | ------------------ | -------------------- |
| `file does not exist`                  | æ–‡ä»¶ä¸å­˜åœ¨         | æ£€æŸ¥æ–‡ä»¶è·¯å¾„         |
| `encryption key must be 32 bytes long` | å¯†é’¥é•¿åº¦é”™è¯¯       | ç¡®ä¿å¯†é’¥æ­£å¥½ 32 å­—èŠ‚ |
| `attachment not found`                 | æ–‡ä»¶æœªè¢«ç­¾å       | ä½¿ç”¨æ­£ç¡®çš„ç­¾åæ–‡ä»¶   |
| `decryption failed`                    | å¯†é’¥é”™è¯¯æˆ–æ•°æ®æŸå | ä½¿ç”¨æ­£ç¡®çš„å¯†é’¥       |

### å¯†é’¥ç”Ÿæˆå»ºè®®

**æ–¹æ³• 1ï¼šä½¿ç”¨éšæœºå­—ç¬¦ä¸²**
```bash
# ç”Ÿæˆ 32 å­—èŠ‚éšæœºå¯†é’¥ï¼ˆBase64ï¼‰
openssl rand -base64 32 | head -c 32
```

**æ–¹æ³• 2ï¼šä½¿ç”¨å¯†ç çŸ­è¯­**
```bash
# ä»å¯†ç çŸ­è¯­æ´¾ç”Ÿå¯†é’¥
echo -n "your-passphrase" | openssl dgst -sha256 -binary | base64 | head -c 32
```

**é‡è¦æç¤ºï¼š**
- âš ï¸ å¯†é’¥å¿…é¡»å®‰å…¨ä¿å­˜ï¼Œä¸¢å¤±åæ— æ³•æ¢å¤è¿½è¸ªä¿¡æ¯
- âš ï¸ ä¸åŒæ–‡ä»¶åº”ä½¿ç”¨ä¸åŒå¯†é’¥ä»¥æé«˜å®‰å…¨æ€§
- âš ï¸ å¯†é’¥ä¸åº”åœ¨ä»£ç æˆ–é…ç½®æ–‡ä»¶ä¸­æ˜æ–‡å­˜å‚¨

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### è®¾è®¡åŸåˆ™

1. **åˆ†å±‚æ¶æ„**ï¼šèŒè´£æ¸…æ™°åˆ†ç¦»ï¼ˆåŠ å¯†å±‚ã€é”šç‚¹å±‚ã€éªŒè¯å±‚ï¼‰
2. **æ¥å£é©±åŠ¨**ï¼šä½¿ç”¨ `Anchor` æ¥å£æ”¯æŒå¤šç§éšå†™æŠ€æœ¯
3. **å¼€æ”¾æ‰©å±•**ï¼šé€šè¿‡ `AnchorRegistry` è½»æ¾æ·»åŠ æ–°çš„é”šç‚¹ç±»å‹
4. **å‘åå…¼å®¹**ï¼šä¿ç•™æ—§å‡½æ•°ä½œä¸º Deprecated åŒ…è£…å™¨

### æ¨¡å—ç»“æ„

```
injector/
â”œâ”€â”€ watermark.go            # ä¸»å…¥å£ - Sign/Verify å…¬å…± API (180 è¡Œ)
â”œâ”€â”€ crypto.go              # åŠ å¯†/è§£å¯†æ¨¡å— (89 è¡Œ)
â”œâ”€â”€ validation.go          # è¾“å…¥éªŒè¯å’Œè·¯å¾„å¤„ç† (66 è¡Œ)
â”œâ”€â”€ anchor.go              # é”šç‚¹æ¥å£å®šä¹‰å’Œæ³¨å†Œè¡¨ (57 è¡Œ)
â”œâ”€â”€ anchor_attachment.go   # é™„ä»¶é”šç‚¹å®ç° (85 è¡Œ)
â”œâ”€â”€ anchor_smask.go        # SMask é”šç‚¹å®ç° (410 è¡Œ)
â”œâ”€â”€ phase7_test.go         # Phase 7 é›†æˆæµ‹è¯• (347 è¡Œ)
â””â”€â”€ watermark_test.go      # å•å…ƒæµ‹è¯• (387 è¡Œ)
```

**æ€»ä»£ç é‡**: 1621 è¡Œ (vs åŸæ¥ ~768 è¡Œï¼Œé‡æ„åå¢åŠ äº†æ¨¡å—åŒ–å’Œå¯æ‰©å±•æ€§)

### æ ¸å¿ƒç»„ä»¶

#### 1. CryptoManager (crypto.go)

**èŒè´£**: åŠ å¯†å’Œè§£å¯†æ“ä½œ

```go
type CryptoManager struct {
    key []byte
}

// æ ¸å¿ƒæ–¹æ³•
func (c *CryptoManager) Encrypt(message string) ([]byte, error)
func (c *CryptoManager) Decrypt(payload []byte) (string, error)
```

**ç‰¹æ€§**:
- AES-256-GCM è®¤è¯åŠ å¯†
- Magic Header (0xCA 0xFE 0xBA 0xBE) ç”¨äºæ ¡éªŒ
- 12 å­—èŠ‚éšæœº Nonce
- Payload æ ¼å¼: `MagicHeader + Nonce + EncryptedData`

### 2. Anchor æ¥å£ (anchor.go)

**èŒè´£**: å®šä¹‰éšå†™é”šç‚¹çš„ç»Ÿä¸€æ¥å£

```go
type Anchor interface {
    Name() string
    Inject(inputPath, outputPath string, payload []byte) error
    Extract(filePath string) ([]byte, error)
    IsAvailable(ctx *model.Context) bool
}
```

**ä¼˜åŠ¿**:
- ç»Ÿä¸€ä¸åŒéšå†™æŠ€æœ¯çš„æ“ä½œ
- æ”¯æŒè¿è¡Œæ—¶æ£€æµ‹é”šç‚¹å¯ç”¨æ€§
- æ˜“äºæ·»åŠ æ–°çš„éšå†™æ–¹æ³•

### 3. AnchorRegistry (anchor.go)

**èŒè´£**: ç®¡ç†å’Œæ³¨å†Œé”šç‚¹å®ç°

```go
type AnchorRegistry struct {
    anchors []Anchor
}

func NewAnchorRegistry() *AnchorRegistry  // é»˜è®¤æ³¨å†Œ Attachment + SMask
func (r *AnchorRegistry) AddAnchor(anchor Anchor)  // æ·»åŠ è‡ªå®šä¹‰é”šç‚¹
```

### 4. AttachmentAnchor (anchor_attachment.go)

**æŠ€æœ¯**: PDF é™„ä»¶éšå†™

**ç‰¹ç‚¹**:
- æ ‡å‡† PDF ç‰¹æ€§ï¼Œå…¼å®¹æ€§å¼º
- æ˜“äºæ£€æµ‹å’Œç§»é™¤ï¼ˆä¸»é”šç‚¹ï¼‰
- å§‹ç»ˆå¯ç”¨ï¼ˆ`IsAvailable` è¿”å› trueï¼‰

**å®ç°ç»†èŠ‚**:
- é™„ä»¶åç§°: `font_license.txt`ï¼ˆä¼ªè£…æˆå­—ä½“è®¸å¯è¯ï¼‰
- ä½¿ç”¨ pdfcpu çš„ `AddAttachmentsFile` API

### 5. SMaskAnchor (anchor_smask.go)

**æŠ€æœ¯**: å›¾åƒè½¯è’™ç‰ˆï¼ˆSoft Maskï¼‰éšå†™

**ç‰¹ç‚¹**:
- é«˜éšè”½æ€§ï¼ˆå¤‡ä»½é”šç‚¹ï¼‰
- éœ€è¦ PDF ä¸­è‡³å°‘æœ‰ä¸€å¼ å›¾åƒ
- æ•°æ®åµŒå…¥åœ¨è’™ç‰ˆæœ«å°¾ï¼Œå¯¹è§†è§‰æ— å½±å“

**å®ç°ç»†èŠ‚**:
- æ‰«æ xRefTable æŸ¥æ‰¾å›¾åƒå¯¹è±¡
- åˆ›å»ºé€æ˜è’™ç‰ˆï¼ˆå…¨ 255 = å®Œå…¨ä¸é€æ˜ï¼‰
- Payload åµŒå…¥ä½ç½®: è’™ç‰ˆæ•°æ®æœ«å°¾
- å‹ç¼©: FlateDecode (zlib)
- æå–ç­–ç•¥: ä»æœ«å°¾ 500 bytes æ‰«æ Magic Header

**å…³é”®ä¿®å¤** (Phase 7.1):
1. å›¾åƒæŸ¥æ‰¾: xRefTable å…¨å±€æ‰«æ
2. å¯¹è±¡æŒä¹…åŒ–: é‡å»º StreamDictï¼ˆè§£å†³å€¼ç±»å‹é—®é¢˜ï¼‰
3. Filter å£°æ˜: æ˜¾å¼æ·»åŠ  `FlateDecode`
4. æ•°æ®æº: ä½¿ç”¨ `Raw`ï¼ˆå‹ç¼©ï¼‰è€Œé `Content`ï¼ˆæœªå‹ç¼©ï¼‰
5. Payload å®šä½: Magic Header æ‰«æï¼ˆå–ä»£å›ºå®šå¤§å°ï¼‰

### 6. Validation (validation.go)

**èŒè´£**: è¾“å…¥éªŒè¯å’Œè·¯å¾„å¤„ç†

**å‡½æ•°**:
- `validateInputs()`: ç­¾åå‚æ•°éªŒè¯
- `validateVerifyInputs()`: éªŒè¯å‚æ•°éªŒè¯
- `generateOutputPath()`: ç”Ÿæˆè¾“å‡ºæ–‡ä»¶è·¯å¾„

## ğŸ”„ å·¥ä½œæµç¨‹

### Sign ç­¾åæµç¨‹

```
1. validateInputs()        â†’ éªŒè¯è¾“å…¥å‚æ•°
2. CryptoManager.Encrypt() â†’ åŠ å¯†æ¶ˆæ¯
3. generateOutputPath()    â†’ ç”Ÿæˆä¸´æ—¶å’Œæœ€ç»ˆè·¯å¾„
4. AttachmentAnchor.Inject() â†’ åµŒå…¥é™„ä»¶é”šç‚¹ï¼ˆä¸»é”šç‚¹ï¼‰
5. SMaskAnchor.Inject()    â†’ åµŒå…¥ SMask é”šç‚¹ï¼ˆå¤‡ä»½é”šç‚¹ï¼‰
   - æˆåŠŸ: åŒè½¨ç­¾å
   - å¤±è´¥: é™çº§ä¸ºå•é”šç‚¹ï¼ˆä»…é™„ä»¶ï¼‰
```

### Verify éªŒè¯æµç¨‹

```
1. validateVerifyInputs()  â†’ éªŒè¯è¾“å…¥å‚æ•°
2. AnchorRegistry.GetAvailableAnchors() â†’ è·å–é”šç‚¹åˆ—è¡¨
3. éå†é”šç‚¹:
   a. Anchor.Extract()      â†’ æå– Payload
   b. CryptoManager.Decrypt() â†’ è§£å¯†å’ŒéªŒè¯
   c. æˆåŠŸ â†’ è¿”å›æ¶ˆæ¯
4. æ‰€æœ‰é”šç‚¹å¤±è´¥ â†’ è¿”å›é”™è¯¯
```

**å®¹é”™è®¾è®¡**: ä»»ä¸€é”šç‚¹éªŒè¯æˆåŠŸå³å¯ï¼ˆOR é€»è¾‘ï¼‰

## ğŸ¯ æ‰©å±•æ€§ç¤ºä¾‹

### æ·»åŠ æ–°çš„é”šç‚¹ç±»å‹

```go
// 1. å®ç° Anchor æ¥å£
type MetadataAnchor struct{}

func (a *MetadataAnchor) Name() string { return "Metadata" }
func (a *MetadataAnchor) Inject(inputPath, outputPath string, payload []byte) error { ... }
func (a *MetadataAnchor) Extract(filePath string) ([]byte, error) { ... }
func (a *MetadataAnchor) IsAvailable(ctx *model.Context) bool { ... }

// 2. æ³¨å†Œåˆ° Registry
registry := NewAnchorRegistry()
registry.AddAnchor(&MetadataAnchor{})

// 3. è‡ªåŠ¨å‚ä¸ Sign/Verify æµç¨‹ï¼ˆæ— éœ€ä¿®æ”¹ä¸»é€»è¾‘ï¼‰
```

## ğŸ“Š æ€§èƒ½æŒ‡æ ‡

| æ“ä½œ               | å¹³å‡è€—æ—¶ | æ–‡ä»¶å¤§å°å½±å“      |
| ------------------ | -------- | ----------------- |
| ç­¾å (Dual-Anchor) | ~40ms    | -0.65% (è½»å¾®å‡å°) |
| éªŒè¯ (Attachment)  | <1ms     | -                 |
| éªŒè¯ (SMask)       | ~10ms    | -                 |

**æ³¨**: æ–‡ä»¶å¤§å°å‡å°æ˜¯å› ä¸º pdfcpu ä¼˜åŒ–äº† PDF ç»“æ„

## ğŸ”’ å®‰å…¨æ€§ï¼šæ·±å…¥è§£æ

### åŠ å¯†ç®—æ³•ä¸ç‰¹æ€§

- **ç®—æ³•**ï¼šAES-256-GCM (Galois/Counter Mode)ï¼Œå†›äº‹çº§åŠ å¯†å¼ºåº¦ã€‚
- **å¯†é’¥é•¿åº¦**ï¼š256 ä½ (32 å­—èŠ‚)ï¼Œç¡®ä¿é«˜å®‰å…¨æ€§ã€‚
- **è®¤è¯åŠ å¯† (AEAD)**ï¼šå†…ç½®å®Œæ•´æ€§éªŒè¯ï¼Œé˜²æ­¢ä»»ä½•å¯¹è¿½è¸ªä¿¡æ¯çš„ç¯¡æ”¹ã€‚
- **éšæœº Nonce**ï¼šæ¯æ¬¡ç­¾åç”Ÿæˆå”¯ä¸€çš„éšæœºæ•°ï¼Œå¢åŠ åŠ å¯†çš„ä¸å¯é¢„æµ‹æ€§ã€‚
- **Magic Header**ï¼šå¿«é€Ÿè¯†åˆ«å’ŒéªŒè¯ Payload çš„å®Œæ•´æ€§ã€‚

### Defender çš„å¤šå±‚å®‰å…¨æœºåˆ¶ (Phase 7.1)

âœ… **æœºå¯†æ€§**ï¼šå³ä½¿æ”»å‡»è€…è·å–æ–‡ä»¶ï¼Œæ²¡æœ‰å¯†é’¥ä¹Ÿæ— æ³•è¯»å–è¿½è¸ªä¿¡æ¯ã€‚
âœ… **å®Œæ•´æ€§**ï¼šGCM æ¨¡å¼è‡ªåŠ¨éªŒè¯æ•°æ®å®Œæ•´æ€§ï¼Œé˜²æ­¢ç¯¡æ”¹ã€‚
âœ… **éšè”½æ€§**ï¼šé€šè¿‡é™„ä»¶å’Œ SMask åŒé”šç‚¹ï¼Œå°†è¿½è¸ªä¿¡æ¯éšè”½åœ°åµŒå…¥åˆ° PDF æ–‡ä»¶ä¸­ã€‚
âœ… **éŸ§æ€§**ï¼šåŒé”šç‚¹é˜²å¾¡æ˜¾è‘—æé«˜äº†çº¢é˜Ÿæ¸…é™¤è¿½è¸ªä¿¡æ¯çš„éš¾åº¦å’Œæˆæœ¬ã€‚

### å®‰å…¨æœ€ä½³å®è·µ

1. **å¯†é’¥ç®¡ç†**
   - ä½¿ç”¨å¼ºéšæœºå¯†é’¥ï¼ˆè‡³å°‘ 256 ä½ç†µï¼‰ã€‚
   - å®‰å…¨å­˜å‚¨å¯†é’¥ï¼ˆä½¿ç”¨å¯†é’¥ç®¡ç†ç³»ç»Ÿæˆ–ç¯å¢ƒå˜é‡ï¼‰ï¼Œç»ä¸ç¡¬ç¼–ç ã€‚
   - å®šæœŸè½®æ¢å¯†é’¥ã€‚

2. **æ–‡ä»¶ä¿æŠ¤**
   - åŸå§‹æ–‡ä»¶å’Œç­¾åæ–‡ä»¶åˆ†å¼€å­˜å‚¨ã€‚
   - é™åˆ¶ç­¾åæ–‡ä»¶çš„è®¿é—®æƒé™ã€‚
   - è®°å½•æ‰€æœ‰ç­¾åå’ŒéªŒè¯æ“ä½œï¼Œè¿›è¡Œå®‰å…¨å®¡è®¡ã€‚

3. **æ“ä½œå®‰å…¨**
   - ä¸åœ¨å‘½ä»¤å†å²ä¸­æš´éœ²å¯†é’¥ï¼ˆä½¿ç”¨ç¯å¢ƒå˜é‡ï¼‰ã€‚
   - éªŒè¯åç«‹å³æ¸…é™¤ä¸´æ—¶æ–‡ä»¶ã€‚
   - ç›‘æ§å¼‚å¸¸çš„éªŒè¯å¤±è´¥ï¼Œè­¦æƒ•æ½œåœ¨æ”»å‡»å°è¯•ã€‚


## ğŸ® æ”»é˜²æ¼”ä¹ å†å²

Defender åœ¨ PhantomStream æ”»é˜²æ¼”ä¹ ä¸­ç»å†äº†å¤šä¸ªé˜¶æ®µçš„è¿›åŒ–ï¼š

| é˜¶æ®µ          | ç­–ç•¥                        | çº¢é˜Ÿæ”»å‡»                              | ç»“æœ            |
| ------------- | --------------------------- | ------------------------------------- | --------------- |
| Phase 1-4     | ç‰©ç†/ç»“æ„å±‚é˜²å¾¡             | æˆªæ–­ / é—´éš™è¦†ç›– / ç‰ˆæœ¬å›æ»š / å›¾è°±ä¿®å‰ª | âŒ å¤±è´¥          |
| Phase 5       | åµŒå…¥å¼é™„ä»¶ (å•é”šç‚¹)         | è¯­ä¹‰åˆ†æ (æˆåŠŸæ£€æµ‹ï¼Œä½†æ— æ³•æ— æŸæ¸…é™¤)   | âœ… é˜¶æ®µæ€§æˆåŠŸ    |
| Phase 6       | æµå†…å®¹æ¸…æ´—çªç ´              | ç²¾å‡†æµæ¸…æ´— (ä¿æŒå­—èŠ‚é•¿åº¦æ›¿æ¢å†…å®¹)     | âŒ å¤±è´¥ (è¢«çªç ´) |
| Phase 7.1     | åŒè½¨éªŒè¯ (é™„ä»¶ + SMask) | æ·±åº¦æ¢æµ‹ / æ¸…é™¤é™„ä»¶ (SMask ä»æœ‰æ•ˆ)    | âœ… æˆåŠŸé˜²å¾¡  |
| Phase 7.2     | æ¶æ„é‡æ„                | (å†…éƒ¨ä¼˜åŒ–)                            | âœ… æå‡å¯æ‰©å±•æ€§  |
| **Phase 8**   | **å¤šé”šç‚¹é˜²å¾¡ (4é”šç‚¹)** | ç»§ç»­æ¼”ä¹ ä¸­                            | âœ… **æŒç»­é˜²å¾¡**  |

**Phase 8 å…³é”®æ”¹è¿›ï¼š**
- ğŸ¯ æ–°å¢ Content é”šç‚¹ï¼Œä¸é¡µé¢æ¸²æŸ“é€»è¾‘ç»‘å®šã€‚
- ğŸŒ³ æ–°å¢ Visual æ°´å°ï¼Œæä¾›æ˜æ–‡éœ‡æ…‘ã€‚
- ğŸ”„ æ”¯æŒ Auto/All ä¸¤ç§éªŒè¯æ¨¡å¼ï¼Œçµæ´»é€‚åº”ä¸åŒåœºæ™¯ã€‚
- ğŸ¯ äº¤äº’æ¨¡å¼ Lookup åŠŸèƒ½ï¼Œä¸€é”®éªŒè¯ä¸Šæ¬¡ç­¾åã€‚

è¯¦ç»†æ¼”ä¹ æŠ¥å‘Šï¼š[/docs/PHANTOM_STREAM_JOINT_REPORT.md](../docs/PHANTOM_STREAM_JOINT_REPORT.md)

## â“ FAQ

### Q1: ç­¾ååçš„ PDF æ–‡ä»¶ä¼šå˜å¤§å—ï¼Ÿ

A: ä¸ä¼šæ˜¾è‘—å˜å¤§ã€‚ç”±äº pdfcpu åœ¨æ·»åŠ é™„ä»¶æ—¶ä¼šä¼˜åŒ–æ–‡ä»¶ç»“æ„ï¼Œå®é™…ä¸Šæ–‡ä»¶å¯èƒ½åè€Œç•¥å¾®å‡å°ã€‚è¿½è¸ªä¿¡æ¯æœ¬èº«é€šå¸¸åªæœ‰å‡ åå­—èŠ‚ã€‚

### Q2: ç­¾ååçš„ PDF æ˜¯å¦è¿˜èƒ½æ­£å¸¸é˜…è¯»ï¼Ÿ

A: å®Œå…¨å¯ä»¥ã€‚æ‰€æœ‰ä¸»æµ PDF é˜…è¯»å™¨ï¼ˆAdobe Acrobatã€Chromeã€Preview ç­‰ï¼‰éƒ½èƒ½æ­£å¸¸æ‰“å¼€å’Œé˜…è¯»ç­¾ååçš„æ–‡ä»¶ã€‚

### Q3: ç”¨æˆ·èƒ½çœ‹åˆ°é™„ä»¶å—ï¼Ÿ

A: å¦‚æœç”¨æˆ·åœ¨ PDF é˜…è¯»å™¨ä¸­æ‰“å¼€"é™„ä»¶"é¢æ¿ï¼Œä¼šçœ‹åˆ°ä¸€ä¸ªåä¸º `font_license.txt` çš„æ–‡ä»¶ã€‚SMask é”šç‚¹åˆ™åœ¨è§†è§‰ä¸Šå®Œå…¨ä¸å¯è§ã€‚

### Q4: å¦‚æœå¿˜è®°å¯†é’¥æ€ä¹ˆåŠï¼Ÿ

A: æ— æ³•æ¢å¤ã€‚AES-256-GCM æ˜¯å¼ºåŠ å¯†ç®—æ³•ï¼Œæ²¡æœ‰å¯†é’¥å°±æ— æ³•è§£å¯†ã€‚å› æ­¤å¯†é’¥ç®¡ç†è‡³å…³é‡è¦ã€‚

**å»ºè®®ï¼š** ä½¿ç”¨å¯†é’¥ç®¡ç†ç³»ç»Ÿï¼ˆå¦‚ HashiCorp Vaultï¼‰æˆ–å®‰å…¨åœ°è®°å½•å¯†é’¥ã€‚

### Q5: èƒ½å¦å¯¹å·²ç­¾åçš„æ–‡ä»¶å†æ¬¡ç­¾åï¼Ÿ

A: å¯ä»¥ï¼Œä½†ä¼šç”Ÿæˆæ–°çš„é”šç‚¹ã€‚ç”±äºé»˜è®¤é™„ä»¶åç›¸åŒï¼Œå¯èƒ½ä¼šè¦†ç›–åŸæœ‰è¿½è¸ªä¿¡æ¯ã€‚SMask é”šç‚¹åˆ™ä¼šå°è¯•å¯»æ‰¾ä¸‹ä¸€ä¸ªå¯ç”¨å›¾åƒè¿›è¡Œæ³¨å…¥ã€‚

**å»ºè®®ï¼š** ä½¿ç”¨ä¸åŒçš„é™„ä»¶åæˆ–åœ¨æ¶ˆæ¯ä¸­åŒ…å«ç‰ˆæœ¬ä¿¡æ¯ï¼Œæˆ–è€ƒè™‘ç¦ç”¨é‡å¤ç­¾åã€‚

### Q6: çº¢é˜Ÿèƒ½å¦æ¸…é™¤è¿½è¸ªä¿¡æ¯ï¼Ÿ

A: çº¢é˜Ÿå¿…é¡»åŒæ—¶å‘ç°å¹¶æ¸…é™¤æ‰€æœ‰é”šç‚¹æ‰èƒ½å®Œå…¨å¤±æ•ˆç­¾åã€‚Phase 7.1 å¼•å…¥çš„ SMask é”šç‚¹å…·æœ‰æé«˜éšè”½æ€§ï¼Œæ˜¾è‘—æå‡äº†çº¢é˜Ÿçš„æ¸…é™¤éš¾åº¦å’Œæˆæœ¬ã€‚ä»»ä½•å°è¯•æ¸…é™¤ SMask é”šç‚¹çš„è¡Œä¸ºéƒ½å¯èƒ½å¯¼è‡´å›¾åƒæ˜¾ç¤ºå¼‚å¸¸ï¼Œä»è€Œæå‡çº¢é˜Ÿçš„æ”»å‡»æˆæœ¬ã€‚

### Q7: å¯†é’¥é•¿åº¦ä¸ºä»€ä¹ˆå¿…é¡»æ˜¯ 32 å­—èŠ‚ï¼Ÿ

A: AES-256 ç®—æ³•è¦æ±‚å¯†é’¥é•¿åº¦ä¸º 256 ä½ï¼ˆ32 å­—èŠ‚ï¼‰ã€‚è¿™æ˜¯ç®—æ³•è§„èŒƒçš„è¦æ±‚ï¼Œç¡®ä¿åŠ å¯†å¼ºåº¦ã€‚

### Q8: èƒ½å¦æ‰¹é‡å¤„ç†å¤šä¸ªæ–‡ä»¶ï¼Ÿ

A: å½“å‰ç‰ˆæœ¬ä¸æ”¯æŒã€‚ä½†å¯ä»¥é€šè¿‡ shell è„šæœ¬å®ç°ï¼š

```bash
#!/bin/bash
KEY="your-32-byte-secret-key-here!!"

for file in *.pdf; do
  ./defender sign -f "$file" -m "Batch:$(date +%s)" -k "$KEY"
done
```

## ğŸ”® æœªæ¥æ”¹è¿›æ–¹å‘

### Phase 8 å€™é€‰ç‰¹æ€§

1. **XMP Metadata Anchor**ï¼šåˆ©ç”¨ PDF XMP å…ƒæ•°æ®
2. **Page Annotation Anchor**ï¼šåˆ©ç”¨æ³¨é‡Šå¯¹è±¡
3. **Transparency Group Anchor**ï¼šåˆ©ç”¨é€æ˜åº¦ç»„
4. **Font Subsetting Anchor**ï¼šåˆ©ç”¨å­—ä½“å­é›†åŒ–

### æ¶æ„æ”¹è¿›

- [ ] å¹¶è¡Œé”šç‚¹æ³¨å…¥ï¼ˆç›®å‰æ˜¯é¡ºåºï¼‰
- [ ] é”šç‚¹ä¼˜å…ˆçº§é…ç½®
- [ ] è‡ªå®šä¹‰é”šç‚¹é€‰æ‹©ç­–ç•¥
- [ ] ç­¾åå…ƒæ•°æ®ï¼ˆç‰ˆæœ¬ã€æ—¶é—´æˆ³ï¼‰
- [ ] é”šç‚¹å¥åº·åº¦ç›‘æ§ï¼ˆæˆåŠŸç‡ç»Ÿè®¡ï¼‰

## ğŸ“œ è®¸å¯è¯

æœ¬é¡¹ç›®æ˜¯ PhantomStream æ”»é˜²æ¼”ä¹ ç³»ç»Ÿçš„ä¸€éƒ¨åˆ†ï¼Œä»…ç”¨äºæ•™è‚²å’Œç ”ç©¶ç›®çš„ã€‚

## ğŸ¤ è´¡çŒ®

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·æäº¤ Issue æˆ– Pull Requestã€‚

---

**Defender - å®ˆæŠ¤æ‚¨çš„æ•°å­—èµ„äº§ï¼** ğŸ›¡ï¸âœ¨