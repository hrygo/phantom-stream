.PHONY: help all build install clean \
	test test-unit test-integration test-race test-all test-coverage bench \
	lint fmt vet check \
	deps tidy dev-deps \
	sign verify

# --- å…¨å±€å˜é‡ ---
BINARY_NAME := phantom-guard
BUILD_DIR := ./bin
GO := go
GOFLAGS := -v
LDFLAGS := -ldflags "-s -w"

# æµ‹è¯•é…ç½®
TEST_TIMEOUT := 30s
COVERAGE_FILE := coverage.out
COVERAGE_HTML := coverage.html
INTEGRATION_TAG := integration

# é»˜è®¤æµ‹è¯•æ•°æ®
DEFAULT_KEY := 12345678901234567890123456789012
TEST_PDF := testdata/2511.17467v2.pdf

# é¢œè‰²å®šä¹‰
COLOR_RESET   := \033[0m
COLOR_BOLD    := \033[1m
COLOR_RED     := \033[31m
COLOR_GREEN   := \033[32m
COLOR_YELLOW  := \033[33m
COLOR_BLUE    := \033[34m
COLOR_PURPLE  := \033[35m
COLOR_CYAN    := \033[36m
COLOR_WHITE   := \033[37m

# é»˜è®¤ç›®æ ‡
.DEFAULT_GOAL := help

##@ General

help: ## æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
	@echo "$(COLOR_BOLD)$(COLOR_BLUE)Defender - PhantomGuard å¼€å‘æ„å»ºå·¥å…·$(COLOR_RESET)"
	@echo ""
	@echo "$(COLOR_BOLD)ä½¿ç”¨è¯´æ˜:$(COLOR_RESET)"
	@echo "  make [command] [VARIABLE=value]"
	@echo ""
	@echo "$(COLOR_BOLD)å¯ç”¨å‘½ä»¤:$(COLOR_RESET)"
	@awk 'BEGIN {FS = ":.*##"; printf ""} \
		/^##@/ { printf "\n$(COLOR_PURPLE)%s$(COLOR_RESET)\n", substr($$0, 5) } \
		/^[a-zA-Z_-]+:.*?##/ { printf "  $(COLOR_CYAN)%-20s$(COLOR_RESET) %s\n", $$1, $$2 }' $(MAKEFILE_LIST)
	@echo ""

all: clean deps check build ## æ‰§è¡Œå®Œæ•´ CI æµç¨‹ (æ¸…ç† -> ä¾èµ– -> æ£€æŸ¥ -> ç¼–è¯‘)

clean: ## æ¸…ç†æ„å»ºäº§ç‰©ã€ç¼“å­˜å’Œä¸´æ—¶æ–‡ä»¶
	@echo "$(COLOR_YELLOW)ğŸ§¹ æ¸…ç†ç¯å¢ƒ...$(COLOR_RESET)"
	@rm -rf $(BUILD_DIR)
	@rm -f $(COVERAGE_FILE) $(COVERAGE_HTML)
	@rm -f *_signed.pdf *_temp*.pdf
	@$(GO) clean -cache -testcache
	@echo "$(COLOR_GREEN)âœ… æ¸…ç†å®Œæˆ$(COLOR_RESET)"

##@ Build & Install

build: ## ç¼–è¯‘å‘å¸ƒç‰ˆæœ¬ (stripped & optimized)
	@echo "$(COLOR_YELLOW)ğŸ”¨ ç¼–è¯‘å‘å¸ƒç‰ˆæœ¬...$(COLOR_RESET)"
	@mkdir -p $(BUILD_DIR)
	@$(GO) build $(GOFLAGS) $(LDFLAGS) -o $(BUILD_DIR)/$(BINARY_NAME) .
	@echo "$(COLOR_GREEN)âœ… ç¼–è¯‘æˆåŠŸ: $(BUILD_DIR)/$(BINARY_NAME)$(COLOR_RESET)"

build-dev: ## ç¼–è¯‘å¼€å‘ç‰ˆæœ¬ (ä¿ç•™è°ƒè¯•ç¬¦å·)
	@echo "$(COLOR_YELLOW)ğŸ”¨ ç¼–è¯‘å¼€å‘ç‰ˆæœ¬...$(COLOR_RESET)"
	@mkdir -p $(BUILD_DIR)
	@$(GO) build $(GOFLAGS) -o $(BUILD_DIR)/$(BINARY_NAME) .
	@echo "$(COLOR_GREEN)âœ… å¼€å‘ç‰ˆæœ¬ç¼–è¯‘æˆåŠŸ$(COLOR_RESET)"

install: build ## å®‰è£…åˆ°ç³»ç»Ÿè·¯å¾„ (/usr/local/bin)
	@echo "$(COLOR_YELLOW)ğŸ“¦ å®‰è£…åˆ°ç³»ç»Ÿ...$(COLOR_RESET)"
	@cp $(BUILD_DIR)/$(BINARY_NAME) /usr/local/bin/
	@echo "$(COLOR_GREEN)âœ… å®‰è£…å®Œæˆ$(COLOR_RESET)"

##@ Development & Testing

test: test-unit ## è¿è¡Œæ ‡å‡†å•å…ƒæµ‹è¯•

test-unit: ## è¿è¡Œå•å…ƒæµ‹è¯• (æ’é™¤é›†æˆæµ‹è¯•)
	@echo "$(COLOR_YELLOW)ğŸ§ª è¿è¡Œå•å…ƒæµ‹è¯•...$(COLOR_RESET)"
	@$(GO) test ./... -v -timeout $(TEST_TIMEOUT) -short

test-integration: ## è¿è¡Œé›†æˆæµ‹è¯• (éœ€ç¯å¢ƒæ”¯æŒ)
	@echo "$(COLOR_YELLOW)ğŸ§ª è¿è¡Œé›†æˆæµ‹è¯•...$(COLOR_RESET)"
	@if [ ! -f $(TEST_PDF) ]; then \
		echo "$(COLOR_RED)âš ï¸  è­¦å‘Š: æµ‹è¯•æ–‡ä»¶ $(TEST_PDF) ä¸å­˜åœ¨$(COLOR_RESET)"; \
	fi
	@$(GO) test ./... -v -tags=$(INTEGRATION_TAG) -timeout 2m

test-race: ## è¿è¡Œç«æ€æ£€æµ‹
	@echo "$(COLOR_YELLOW)ğŸƒ è¿è¡Œç«æ€æ£€æµ‹...$(COLOR_RESET)"
	@$(GO) test ./... -race -v -timeout $(TEST_TIMEOUT)

test-all: test-unit test-integration ## è¿è¡Œæ‰€æœ‰æµ‹è¯• (å•å…ƒ + é›†æˆ)

test-coverage: ## ç”Ÿæˆå¹¶æŸ¥çœ‹æµ‹è¯•è¦†ç›–ç‡æŠ¥å‘Š
	@echo "$(COLOR_YELLOW)ğŸ“Š ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š...$(COLOR_RESET)"
	@$(GO) test ./... -tags=$(INTEGRATION_TAG) -coverprofile=$(COVERAGE_FILE) -covermode=atomic -timeout 2m
	@$(GO) tool cover -html=$(COVERAGE_FILE) -o $(COVERAGE_HTML)
	@echo "$(COLOR_GREEN)âœ… æŠ¥å‘Šå·²ç”Ÿæˆ: $(COVERAGE_HTML)$(COLOR_RESET)"
	@$(GO) tool cover -func=$(COVERAGE_FILE) | tail -n 1

bench: ## è¿è¡ŒåŸºå‡†æµ‹è¯•
	@echo "$(COLOR_YELLOW)âš¡ è¿è¡ŒåŸºå‡†æµ‹è¯•...$(COLOR_RESET)"
	@$(GO) test ./... -tags=$(INTEGRATION_TAG) -bench=. -benchmem -run=^$$

##@ Quality Control

lint: ## è¿è¡Œä»£ç æ£€æŸ¥ (golangci-lint)
	@echo "$(COLOR_YELLOW)ğŸ” è¿è¡Œä»£ç æ£€æŸ¥...$(COLOR_RESET)"
	@if command -v golangci-lint >/dev/null 2>&1; then \
		golangci-lint run ./...; \
	else \
		echo "$(COLOR_YELLOW)âš ï¸  è­¦å‘Š: golangci-lint æœªå®‰è£…, è·³è¿‡ lint æ£€æŸ¥$(COLOR_RESET)"; \
		echo "   æç¤º: è¿è¡Œ 'make dev-deps' å®‰è£…å¼€å‘å·¥å…·"; \
	fi

fmt: ## æ ¼å¼åŒ–ä»£ç  (go fmt)
	@echo "$(COLOR_YELLOW)âœ¨ æ ¼å¼åŒ–ä»£ç ...$(COLOR_RESET)"
	@$(GO) fmt ./...

vet: ## é™æ€åˆ†æ (go vet)
	@echo "$(COLOR_YELLOW)ğŸ” è¿è¡Œé™æ€åˆ†æ...$(COLOR_RESET)"
	@$(GO) vet ./...

check: fmt vet test-unit ## è¿è¡Œå®Œæ•´è´¨é‡æ£€æŸ¥æµç¨‹ (fmt -> vet -> test)
	@echo "$(COLOR_GREEN)âœ… åŸºç¡€æ£€æŸ¥é€šè¿‡$(COLOR_RESET)"

check-full: fmt vet lint test-unit ## è¿è¡Œå®Œæ•´è´¨é‡æ£€æŸ¥æµç¨‹ (åŒ…æ‹¬ lint)
	@echo "$(COLOR_GREEN)âœ… æ‰€æœ‰æ£€æŸ¥é€šè¿‡$(COLOR_RESET)"

##@ Dependency Management

deps: ## ä¸‹è½½é¡¹ç›®ä¾èµ–
	@echo "$(COLOR_YELLOW)ğŸ“¥ ä¸‹è½½ä¾èµ–...$(COLOR_RESET)"
	@$(GO) mod download

tidy: ## æ•´ç†æ¨¡å—ä¾èµ– (go mod tidy)
	@echo "$(COLOR_YELLOW)ğŸ”§ æ•´ç†ä¾èµ–...$(COLOR_RESET)"
	@$(GO) mod tidy

dev-deps: ## å®‰è£…å¼€å‘å·¥å…· (golangci-lint)
	@echo "$(COLOR_YELLOW)ğŸ“¥ å®‰è£…å¼€å‘ä¾èµ–...$(COLOR_RESET)"
	@$(GO) install github.com/golangci/golangci-lint/cmd/golangci-lint@latest
	@echo "$(COLOR_GREEN)âœ… å®‰è£…å®Œæˆ$(COLOR_RESET)"

##@ Operations (Running)

sign: ## è¿è¡Œç­¾åå·¥å…· (é»˜è®¤ä½¿ç”¨æµ‹è¯•æ–‡ä»¶)
	@echo "$(COLOR_YELLOW)ğŸ›¡ï¸  è¿è¡Œç­¾å...$(COLOR_RESET)"
	@$(eval FILE := $(if $(FILE),$(FILE),$(TEST_PDF)))
	@$(eval KEY := $(if $(KEY),$(KEY),$(DEFAULT_KEY)))
	@$(eval MSG := $(if $(MSG),$(MSG),Protected-$(shell date +%s)))
	@echo "   ğŸ“‚ æ–‡ä»¶: $(FILE)"
	@echo "   ğŸ”‘ å¯†é’¥: $(KEY)"
	@echo "   ğŸ“ æ¶ˆæ¯: $(MSG)"
	@if [ ! -f "$(FILE)" ]; then echo "$(COLOR_RED)âŒ é”™è¯¯: æ–‡ä»¶ $(FILE) ä¸å­˜åœ¨$(COLOR_RESET)"; exit 1; fi
	@$(GO) run . sign -f $(FILE) -m "$(MSG)" -k "$(KEY)"

verify: ## è¿è¡ŒéªŒè¯å·¥å…· (é»˜è®¤éªŒè¯ç”Ÿæˆçš„æµ‹è¯•æ–‡ä»¶)
	@echo "$(COLOR_YELLOW)ğŸ” è¿è¡ŒéªŒè¯...$(COLOR_RESET)"
	@$(eval TARGET_FILE := $(if $(FILE),$(FILE),$(patsubst %.pdf,%_signed.pdf,$(TEST_PDF))))
	@$(eval KEY := $(if $(KEY),$(KEY),$(DEFAULT_KEY)))
	@echo "   ğŸ“‚ æ–‡ä»¶: $(TARGET_FILE)"
	@echo "   ğŸ”‘ å¯†é’¥: $(KEY)"
	@if [ ! -f "$(TARGET_FILE)" ]; then echo "$(COLOR_RED)âŒ é”™è¯¯: æ–‡ä»¶ $(TARGET_FILE) ä¸å­˜åœ¨. è¯·å…ˆè¿è¡Œ 'make sign'$(COLOR_RESET)"; exit 1; fi
	@$(GO) run . verify -f $(TARGET_FILE) -k "$(KEY)"