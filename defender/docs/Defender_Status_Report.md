**PhantomStream 攻防演习 - 蓝队 (Defender) 阶段性技术总结报告**

**日期：** 2025年12月4日
**角色：** Defender (防守方)
**状态：** Phase 6 部署成功，防守胜利！当前红队已能通过语义与结构分析发现我们签名附件的存在，但在不破坏 PDF 文件可读性和结构完整性的前提下，尚未找到有效破坏签名的方法。

---

## 1. 攻防演进脉络 (Timeline)

本次演习经历了六个主要阶段的博弈，蓝队的技术方案随着红队的攻击手段不断迭代。

### 📅 Phase 1-5: 失败尝试与策略调整
*   **简单追加 (Append):** 被红队截断清除。
*   **伪装增量更新 (Fake Update):** 被红队版本回滚 (Rollback) 清除。
*   **对象流注入 (Stream Injection):** 因 PDF 库强制压缩导致验证器失效。
*   **元数据固化 (Metadata Anchoring):** 被红队"图谱清洗"破坏文件结构，但未成功剥离隐写信息。
*   **视觉内容融合 (Visual Content Fusion):** 验证困难，未能形成有效对抗。

### 📅 Phase 6: 嵌入式附件 (Embedded Attachment) - **最终防御成功！**

**蓝队策略（签名载体的最终形态）：**

1.  **注入位置选择：**  
    - 将追踪信息封装为一个 **PDF 嵌入式附件对象 (Embedded File / Attachment)**，而不是追加在 EOF 后、对象间隙或僵尸对象中。  
    - 该附件通过标准引用链 `Catalog -> Names -> EmbeddedFiles` 挂载，成为 **Root 可达对象**，从图结构角度看是"合法成员"而非"垃圾节点"。
    - 当前使用附件名为 `font_license.txt`（已从早期的 `sys_stream.dat` 调整为更具业务合理性的名称）。

2.  **签名与载荷结构：**  
    - 附件本质上是一个二进制文件，内部是经过 **AES-256-GCM** 对称加密后的高熵密文流。  
    - 载荷结构遵循：`Magic Header (0xCA 0xFE 0xBA 0xBE) + Nonce (12 bytes) + CipherText` 的形式。
    - Header 用于快速验证"是否我方生成"，Nonce 保证同一明文在不同样本间不会产生相同密文，CipherText 由 GCM 模式提供认证加密。  
    - 从 PDF 视角看，这只是一段"不可读的用户附件数据"，既不影响页面渲染，也不会改变文字/图片内容。

3.  **抗回滚与历史版本清洗：**  
    - 利用标准 PDF 库（pdfcpu）在添加附件时的"重写 + 优化"行为，将原有的增量更新历史折叠进一个新的、规范的文件结构。  
    - 红队此前依赖的"回滚到首个 xref / trailer"的策略，在这一版本上基本失效——文件已经被重组为一个"干净的当前版本"，没有可剥离的历史层。

4.  **抗图谱清洗（Graph-based Pruning）：**  
    - 红队的图谱清洗主要针对"不可达对象"（孤岛节点）和"非必要元数据"。  
    - 由于我们的附件从 Root 出发即可经 Names/EmbeddedFiles 访问，它被视作 **强连通的合法对象**，与页面树、资源字典共同构成"业务上合理"的结构。  
    - 若红队强行删除该对象或其引用链，极易造成 Names 字典不一致，甚至破坏阅读器对附件面板、文档结构的解析。

5.  **体积与隐蔽性：**  
    - 实际样本显示，附件添加 + 优化后，文件体积非但没有显著膨胀，反而因为压缩和重组出现了小幅收缩（约 6KB 减少）。  
    - 这意味着基于"文件突然变大/变胖"的粗暴启发式检测基本失效，我们的"寄生负载"在宏观上并不显眼。
    - 附件大小通常在 50-80 字节之间，相对于整个 PDF 文件（约 888KB）微不足道。

6.  **验证链路与权利追究：**  
    - 验证端通过标准附件提取 API 获取该二进制附件，并在内存中完成解密与完整性校验。  
    - **AEAD (Authenticated Encryption with Associated Data)** 特性确保：一旦任何人对附件字节流做了修改（包括：部分截断、用无意义数据覆盖、重新压缩等），GCM 认证标签验证就会失败，解密阶段直接报错。  
    - 这保证了在权利追究场景下，我们可以明确区分"完好签名样本"和"被篡改样本"，而不会出现"看起来像原件但我们无法判断"的灰区。

**红队攻击进展（内部情报）：**

- 红队已经通过语义分析与结构扫描工具，**确认样本中存在嵌入式附件**，并给出了"高风险对象"的标记。
- 他们的检测报告显示：
  - **嵌入文件数量**: 1个
  - **可疑文件**: 1个  
  - **威胁评分**: 2.20/3.00（高风险）
  - **可疑特征**: 文件扩展名 .dat（早期版本）、高内容熵、压缩流
- 在策略规划中，红队已经公开提出两个方向：  
  1. **直接清除附件**——即从结构上移除该对象及其引用；  
  2. **内容层替换**——保留附件外壳与结构，但用无效数据填充内部内容，希望绕过结构检查的同时破坏我方签名语义。
- 这说明：我们的"隐身"已经从"完全不可见"演进为"可被高阶检测识别"，但这并不等价于"可以被安全清除"。

**当前验证结果（截至本报告撰写时）：**

- 所有来自红队的样本中，只要 **PDF 页面仍能正常渲染，结构未出现严重错误**，我方验证工具要么成功提取并解密签名，要么在明显被篡改的样本上给出"验证失败"的明确结果。  
- 尚未出现一份满足以下三个条件的红队样本：  
  1. PDF 文件结构完全合法，页面正常可读；  
  2. 不引入明显的解析错误或阅读器告警；  
  3. 同时能够让我方签名验证彻底失效、且难以证明其遭受过篡改。
- 红队交付的 `2511.17467v2_sanitized.pdf` 样本在验证时报错：`attachment not found: pdfcpu: validatePages: cannot dereference pageNodeDict`，说明清洗过程破坏了 PDF 结构完整性。
- 换言之，红队目前在"**发现我们**"这一层取得进展，但在"**无痕清除我们**"这一层仍未找到可行路径。

**阶段性结论（内部视角）：**

- 从**工程稳定性**看：Phase 6 基于标准库（pdfcpu + Go）操作，没有依赖脆弱的手工字节拼接，样本在多次处理后依然保持良好的可读性与解析兼容性。  
- 从**生存能力**看：只要攻击方不愿接受"文档结构被破坏或阅读体验显著下降"的代价，我们的签名就具有极高的存活率。  
- 从**权利追究**看：签名要么保持完好、可被我们验证；要么被粗暴破坏、从而形成"明显异常"的样本，两种情况都有利于我们在后续追责中界定责任与故意行为。  
- **核心优势**：AEAD 加密机制确保了"篡改即失效"，任何对载荷的修改都会导致验证失败，无法伪造有效签名。
- 这意味着当前方案已经达到本轮演习的核心目标：**在现实攻击成本约束下，让追踪手段具备足够的韧性与可用性。**

---

## 2. 关键技术方案：Phase 6 架构

### 2.1 PDF 文件结构

```text
+-----------------------+
|  PDF Header (%PDF-1.4)|
|          ...          |
| 1 0 obj (Catalog)     |
|   /Names 2 0 R        | <--- 引用名称树
| endobj                |
|          ...          |
| 2 0 obj (Names Dict)  |
|   /EmbeddedFiles ...  | <--- 引用嵌入文件树
| endobj                |
|          ...          |
| 10 0 obj (FileSpec)   | <--- 文件描述
|   /EF <</F 11 0 R>>   |
|   /F (font_license.txt) | <--- 附件名称（已优化）
| endobj                |
|          ...          |
| 11 0 obj (Stream)     | <--- 隐写 Payload 驻留于此
| stream                |
|   [Encrypted Data]    |
| endstream             |
| endobj                |
+-----------------------+
```

### 2.2 Payload 详细结构

```
┌──────────────────────────────────────────────────┐
│ Magic Header (4 bytes)    │ 0xCA 0xFE 0xBA 0xBE │
├──────────────────────────────────────────────────┤
│ Nonce (12 bytes)           │ 随机生成（crypto/rand）│
├──────────────────────────────────────────────────┤
│ Encrypted Data (N bytes)   │ AES-256-GCM 加密     │
│                            │ 包含 GCM 认证标签     │
└──────────────────────────────────────────────────┘
```

### 2.3 技术实现细节

**加密流程**：
1. 生成 12 字节随机 Nonce
2. 使用 AES-256-GCM 对追踪消息加密
3. 组装 Payload：Magic Header + Nonce + CipherText
4. 将 Payload 写入临时文件作为附件
5. 使用 pdfcpu API 将附件嵌入 PDF

**验证流程**：
1. 使用 pdfcpu API 提取附件
2. 验证 Magic Header
3. 提取 Nonce 和 CipherText
4. 使用相同密钥进行 GCM 解密
5. GCM 自动验证完整性，篡改会导致解密失败

**工具链**：
- 编程语言：Go 1.24.0
- PDF 操作库：pdfcpu v0.11.1
- CLI 框架：Cobra
- 加密库：Go 标准库 crypto/aes, crypto/cipher

## 3. 红队能力评估与防御强化方向

### 3.1 红队当前能力边界

**已具备的能力**：
- ✅ 通过语义分析识别嵌入式附件的存在
- ✅ 对附件进行风险评分和特征分析
- ✅ 识别可疑的文件名模式和高熵内容

**尚未实现的能力**：
- ❌ 在不破坏 PDF 结构的前提下安全删除附件
- ❌ 用伪数据替换附件同时通过我方 AEAD 验证
- ❌ 绕过 GCM 认证机制伪造有效签名

### 3.2 防御强化方向（未来演进）

**已实施的改进**：
1. **命名优化**：从 `sys_stream.dat` 改为 `font_license.txt`，降低启发式检测命中率
2. **轮次管理**：文件名支持轮次号（如 `*_11_signed.pdf`），避免覆盖历史样本

**待评估的方向**：
1. **多锚点纵深**：在附件基础上增加正文弱水印，形成双轨验证
2. **多附件稀释**：增加 1-2 个合法附件作为掩护，降低单点命中率
3. **内容伪装**：使用 JSON/INI 格式包裹 Base64 编码的密文，降低"不可读字节流"特征
4. **元数据完善**：为附件添加描述、修改时间等字段，提升业务合理性

## 4. 总结与展望

蓝队最终采用了 **Phase 6** 方案，利用 PDF 标准的附件功能实现隐写。这是一种"寄生"策略，将隐写数据合法化为文档的一部分。这种方案不仅工程实现极其稳定（基于标准 API），而且具有极高的生存能力——它既不是"垃圾数据"，也不是"历史版本"，而是"合法内容"。

**核心优势总结**：
1. **结构合法性**：Root 可达，无法通过图谱清洗安全移除
2. **加密完整性**：AEAD 机制确保篡改即失效，无法伪造
3. **工程稳定性**：基于标准库，兼容性和可维护性强
4. **权利追究能力**：清晰区分完好样本与篡改样本

**当前态势**：
- 红队已能发现签名附件的存在
- 但在保持文件可用性的前提下，无法有效破坏签名
- 从权利追究角度，当前方案已满足核心需求

本次攻防演习充分证明了深入理解 PDF 文件结构和利用其标准特性的重要性。面对未来更复杂的语义级清洗，防守方将继续探索多锚点防御、内容伪装等高级策略，但 Phase 6 已经为追踪机制建立了坚实的技术基础。

**Defender triumphs!**
