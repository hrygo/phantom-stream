# [红队] 行动报告: PhantomStream

**版本**: v1.6
**日期**: 2025-12-04
**操作员**: Attacker (红队)

## 1. 执行摘要 (Executive Summary)
本报告详细记录了红队 (Attacker) 在 "PhantomStream" 攻防演习中的行动。在盲测环境下，红队坚持“结构卫生”原则，通过对 PDF 文件结构的深度解析与清洗，成功压制了蓝队 (Defender) 部署的三代隐写防御技术（尾部追加、间隙注入、伪装增量更新），并已针对第四代预期技术（僵尸对象）做好了防御准备。

## 2. 战略原则 (Strategic Doctrine)
本次行动的核心约束是 **盲测 (Blind Test)** 规则。
*   **核心哲学**: **结构卫生 (Structural Hygiene)**。
*   **定义**: "任何不属于有效 PDF 引用图谱的数据，均被视为异常并予以清除。"
*   **操作准则**: 不依赖原始文件比对，完全基于文件格式规范进行异常检测。

## 3. 行动时间线 (Operations Timeline)

```mermaid
graph TD
    subgraph Phase1 [阶段一]
    D1[蓝队: EOF 追加] -->|被检测| A1[红队: 尾部扫描/清洗]
    end
    
    subgraph Phase2 [阶段二]
    A1 -->|迫使进化| D2[蓝队: 间隙注入]
    D2 -->|被检测| A2[红队: 间隙消毒器]
    end
    
    subgraph Phase3 [阶段三]
    A2 -->|迫使进化| D3[蓝队: 伪装增量更新]
    D3 -->|被检测| A3[红队: 版本回滚]
    end
    
    subgraph Phase4 [阶段四]
    A3 -->|迫使进化| D4[蓝队: 僵尸对象/元数据]
    D4 -->|被检测| A4[红队: 图谱修剪]
    end

    subgraph Phase6 [阶段六]
    A4 -->|迫使进化| D6[蓝队: 附件注入]
    D6 -->|绕过| A6[红队: 语义盲区]
    end
    
    style D1 fill:#f9f,stroke:#333,stroke-width:2px
    style D2 fill:#f9f,stroke:#333,stroke-width:2px
    style D3 fill:#f9f,stroke:#333,stroke-width:2px
    style D4 fill:#f9f,stroke:#333,stroke-width:2px
    style D6 fill:#f9f,stroke:#333,stroke-width:2px
    
    style A1 fill:#9ff,stroke:#333,stroke-width:2px
    style A2 fill:#9ff,stroke:#333,stroke-width:2px
    style A3 fill:#9ff,stroke:#333,stroke-width:2px
    style A4 fill:#9ff,stroke:#333,stroke-width:2px
    style A6 fill:#ff9,stroke:#333,stroke-width:2px,stroke-dasharray: 5 5
```

### 阶段一："尾部"时代 (EOF 追加)
*   **对手战术**: 将载荷追加在物理文件结束标记 (`%%EOF`) 之后。
*   **我方响应**: 开发 `Scan` (扫描) 和 `Clean` (清洗) 工具。
*   **技术细节**: 逆向读取文件定位最后一个 `%%EOF`，截断其后数据。
*   **结果**: **完胜 (VICTORY)**。

### 阶段二："间隙"时代 (对象间注入)
*   **对手战术**: 将数据隐藏在 PDF 对象之间的空白间隙中。
*   **我方响应**: 开发 `ScanStructure` (结构扫描) 和 `SanitizeGaps` (间隙消毒) 工具。
*   **技术细节**: 启发式扫描对象间的字节区间，用空格 (`0x20`) 覆盖非空白异常。
*   **结果**: **完胜 (VICTORY)**。

### 阶段三："修订"时代 (伪装增量更新)
*   **对手战术**: 追加合法的 PDF "增量更新" 包，甚至将载荷伪装成 Zlib 压缩流以对抗内容扫描。
*   **我方响应**: 开发 `Rollback` (回滚) 工具。
*   **技术细节**: 检测多个 `%%EOF` 标记，识别修订历史。无论载荷如何伪装（如 Zlib 压缩），只要存在于新修订中，均通过强制回滚物理移除。
*   **结果**: **完胜 (VICTORY)**。成功处置 "Zlib Aware" 变种样本。

### 阶段四："僵尸"时代 (僵尸对象/元数据)
*   **对手战术**: 将数据隐藏在未被引用的 "僵尸对象" 或非必要元数据中，并扁平化文件结构以抵抗回滚。
*   **我方响应**: 开发 `Graph Analyzer` (图谱分析) 和 `Prune` (修剪) 工具。
*   **技术细节**: 构建全量引用图谱，并引入“启发式白名单”与“流对象保护”机制，在无法解析 Object Streams 的盲测环境下，精准区分系统组件与僵尸对象。
*   **结果**: **完胜 (VICTORY)**。成功清除 30 个高可疑度僵尸对象，同时修复了误删导致的文件损坏问题。

### 阶段六："带内"时代 (附件注入)
*   **对手战术**: 将载荷封装为合法的 PDF 附件 (Embedded Files)，使其在引用图谱中 "可达" 且结构合法。
*   **我方响应**: 执行 `Prune` (图谱修剪)。
*   **技术细节**: 僵尸对象修剪工具基于“结构可达性”工作。由于附件被 Catalog 正常引用，工具将其视为合法组件予以保留。
*   **结果**: **失败 (FAILURE)**。核心载荷幸存。当前工具链无法区分“恶意附件”与“正常附件”，必须引入语义分析。

## 4. 技术分析 (Technical Analysis)

### 结构化攻击向量示意图

```text
[ 阶段一: 尾部注入 ]
+------------------+
| PDF Header       |
| ...              |
| %%EOF            |
+------------------+
| [隐藏数据]       | <--- 攻击: 截断 (Clean)
+------------------+

[ 阶段二: 间隙注入 ]
+------------------+
| 1 0 obj ...      |
| endobj           |
+------------------+
| [隐藏数据]       | <--- 攻击: 覆写 (Sanitize)
+------------------+
| 2 0 obj ...      |
+------------------+

[ 阶段三: 增量更新 ]
+------------------+
| 原始 PDF         |
| %%EOF            |
+------------------+
| 新 Body          | <--- 攻击: 回滚 (Strip Revision)
| [隐藏数据]       |
| 新 Trailer       |
| %%EOF            |
+------------------+

[ 阶段四: 僵尸对象 ]
+------------------+
| 1 0 obj (有效)   |
+------------------+
| 99 0 obj (僵尸)  | <--- 攻击: 修剪 (Graph Analysis)
| [隐藏数据]       |      (从 Root 不可达)
+------------------+
| 2 0 obj (有效)   |
+------------------+

[ 阶段六: 附件注入 ]
+------------------+
| Catalog          |
|  \-> Names       |
|      \-> Embed...|
|          |       |
|          v       |
| +--------------+ |
| | FileSpec     | | <--- 攻击无效: 结构合法且可达
| |  \-> Stream  | |      (Prune 必须保留)
| +--------------+ |
+------------------+
```

## 5. 工具链状态 (Toolchain Status)
`attacker` 模块已演变为一套模块化的取证套件：

*   `scan`: 基础尾部扫描。
*   `clean`: 基础尾部截断。
*   `sanitize`: 对象间隙覆写 (针对 Phase 2)。
*   `rollback`: 版本回滚 (针对 Phase 3)。
*   `prune`: 僵尸对象修剪 (针对 Phase 4)。

## 6. 结论与展望 (Conclusion & Outlook)
## 6. 结论与展望 (Conclusion & Outlook)
红队通过快速适应和对 PDF 内部结构的深刻理解，在 Phase 1-4 保持了压倒性优势。然而，Phase 6 标志着对抗进入了 **语义层 (Semantic Layer)**。蓝队成功利用了盲测工具对 "合法结构"（如附件）的信任。未来的红队工具必须具备 **语义级清洗** 能力（如附件白名单、内容流审计），但这将面临可用性与安全性的艰难权衡。
