# PhantomStream PDF 隐写攻防技术报告

**版本**: 1.0
**日期**: 2025-12-05
**作者**: PhantomStream 联合攻防小组 (Defender & Attacker)

---

## 1. 执行摘要 (Executive Summary)

PhantomStream 项目是一次针对 PDF 文档隐写与清洗技术的高强度攻防演习。演习历时 8 个阶段，涵盖了从基础的 Metadata 隐写到高级的流对象注入、再到内容流微扰的多种技术手段。

**最终结果**: 红队 (Attacker) 取得全面胜利，成功清洗了蓝队 (Defender) 部署的所有类型的隐写锚点，同时保持了 PDF 文档的视觉完整性和结构合法性。

**核心发现**: 在现有的 PDF 标准框架下，基于**独立流对象 (Independent Stream Objects)** 的隐写技术无法抵御基于**语义分析与重构 (Semantic Analysis & Reconstruction)** 的清洗攻击。真正的"不可清洗水印"在不破坏文档通用性的前提下极难实现。

---

## 2. 攻防演进时间线 (Evolution Timeline)

| 阶段          | 蓝队防御策略 (Defender)                         | 红队攻击策略 (Attacker)                    | 结果   |
| :------------ | :---------------------------------------------- | :----------------------------------------- | :----- |
| **Phase 1-4** | 基础 Metadata、文本追加、简单附件               | 字符串搜索、正则匹配、对象删除             | 红队胜 |
| **Phase 5-6** | 增强型附件隐写、多重加密                        | 递归对象遍历、流内容置零                   | 红队胜 |
| **Phase 7**   | **双锚点防御**: 附件 + SMask (图像蒙版)         | **合法 Zlib 填充 (Valid Zlib Padding)**    | 红队胜 |
| **Phase 8**   | **三锚点防御**: + Content Stream (TJ 微扰/注释) | **自适应量化清洗 (Adaptive Quantization)** | 红队胜 |

---

## 3. 关键防御技术解析 (Defender Technologies)

### 3.1 附件隐写 (Attachment Steganography)
*   **原理**: 利用 PDF 的 `/EmbeddedFiles` 特性，将加密数据作为附件潜藏在文档中。
*   **优点**: 实现简单，完全符合 PDF 标准，不影响页面显示。
*   **弱点**: 极易被检测和移除。红队只需遍历 `/Names` 字典或直接扫描 `/Type /Filespec` 对象即可定位。

### 3.2 SMask 隐写 (Soft Mask Injection)
*   **原理**: 将隐写数据伪装成图片的 Soft Mask (透明度蒙版) 流。
*   **设计**: 创建一个看起来合法的 Image XObject，将其 `/SMask` 指向存储隐写数据的流。
*   **意图**: 欺骗清洗工具认为这是渲染必须的资源。
*   **弱点**: 虽然难以直接删除（会导致图片显示异常），但可以通过**内容替换**（如替换为全白蒙版或空流）来清洗，而不破坏 PDF 结构。

### 3.3 内容流微扰 (Content Stream Perturbation)
*   **尝试 1: TJ 操作符微扰**: 修改文本显示指令 `[...] TJ` 中的字间距数值。
    *   *失败原因*: 即使微小的修改 (0.001) 也可能导致精密排版的 PDF 出现视觉错乱；且容易被归一化清洗。
*   **尝试 2: 注释隐写**: 在 Content Stream 末尾追加 `% DFNDR:HEX...` 注释。
    *   *失败原因*: 极易被重写 Content Stream 的清洗工具（如 pdfcpu optimize）自动去除。

---

## 4. 关键攻击技术解析 (Attacker Technologies)

### 4.1 递归对象遍历 (Recursive Object Traversal)
红队不依赖简单的字符串搜索，而是解析 PDF 的对象图 (Object Graph)，从 Root 节点开始递归遍历所有引用。这使得红队能够准确识别出哪些对象是"孤儿"（无引用），哪些是"关键结构"，从而进行精准打击。

### 4.2 合法 Zlib 填充 (Valid Zlib Padding)
*   **背景**: 简单的将流内容置零 (`0x00`) 会导致 `zlib: invalid header` 错误，被蓝队检测到。
*   **创新**: 红队构造了一个**合法的、解压后为空的 Zlib 流** (包含合法的 Header 和 Adler32 校验和)。
*   **效果**: 替换目标流后，PDF 解析器认为流是完好的（只是内容为空），从而绕过了基于格式的完整性校验。

### 4.3 自适应量化清洗 (Adaptive Quantization Sanitization)
*   **针对目标**: 图像流和 SMask 流。
*   **原理**:
    1.  解压图像数据。
    2.  对像素数据应用 **LSB (最低有效位) 抹除** (如 `val & 0xFE`) 或 **降位深量化**。
    3.  重新压缩并写回。
*   **效果**: 彻底破坏了隐藏在像素低位中的隐写信息，同时对人眼视觉的影响微乎其微（肉眼无法分辨 1/255 的亮度差异）。

---

## 5. 结论与建议 (Conclusion & Recommendations)

### 5.1 理论极限
本次演习证明，**只要攻击者拥有对文件格式的完全解析能力，且不关心隐写数据的具体内容（只求清除），防御者几乎无法在不牺牲文档质量的前提下保留水印。**

### 5.2 安全建议
对于需要高强度文档保护的场景，建议放弃单纯的客户端隐写，转而采用以下策略：

1.  **全文档加密 (DRM)**: 只有持有密钥的合法用户才能解密并渲染文档。这是目前唯一能有效防止内容被篡改/清洗的手段。
2.  **云端渲染 (Streaming)**: 不下发 PDF 源文件，仅向客户端传输渲染后的像素流（图片/视频帧）。
3.  **数字签名 (Digital Signatures)**: 使用标准的 PDF 数字签名技术。虽然它不能防止清洗（攻击者可以移除签名），但它能保证**不可抵赖性**——任何清洗后的文件都将失去签名验证，从而被识别为"非原件"。

### 5.3 结语
PhantomStream 演习虽然以红队胜利告终，但其探索的技术边界为 PDF 安全领域提供了宝贵的实战数据。攻防相长，技术的进步永无止境。

---
*PhantomStream Project Team*
